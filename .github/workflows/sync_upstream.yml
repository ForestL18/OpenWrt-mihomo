name: Sync Upstream
on:
  schedule:
    - cron: "0 0 * * *" # 每天运行一次
  workflow_dispatch: # 允许手动触发
jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Configure Git
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
      - name: Add Upstream Remote
        run: |
          git remote add upstream https://github.com/morytyann/OpenWrt-mihomo.git
      - name: Fetch Upstream
        run: |
          git fetch upstream
      - name: Switch to Target Branch
        run: |
          git checkout Alpha  # 或者是你想要同步的目标分支名
      - name: Merge Upstream
        run: |
          git merge upstream/main -X ours --no-commit --no-ff
      - name: Restore Excluded Files
        run: |
          git checkout HEAD -- mihomo/Makefile
          git checkout HEAD -- luci-app-mihomo/Makefile
          git checkout HEAD -- .github/workflows/sync_upstream.yml
          git checkout HEAD -- .github/workflows/update_mihomo_hash.yml
          git checkout HEAD -- .github/workflows/build.yml
          git checkout HEAD -- .github/workflows/release.yml
      - name: Commit Changes
        id: commit
        run: |
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            echo "changes_made=false" >> $GITHUB_OUTPUT
          else
            git add .
            git commit -m "Sync upstream changes"
            git push
            echo "changes_made=true" >> $GITHUB_OUTPUT
          fi
      - name: Check for Changes
        run: |
          if [ "${{ steps.commit.outputs.changes_made }}" = "true" ]; then
            echo "Changes were made and pushed to the repository."
          else
            echo "No changes were made. The repository is already up to date."
          fi
